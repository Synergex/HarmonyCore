;;*****************************************************************************
;;
;; Title:       ItemTests.dbl
;;
;; Type:        Class
;;
;; Description: Unit tests for the operations defined in ItemsController.
;;
;;*****************************************************************************
;; WARNING
;;
;; This file was code generated. Avoid editing this file, as any changes that
;; you make will be lost of the file is re-generated.
;;
;;*****************************************************************************
;;
;; Copyright (c) 2018, Synergex International, Inc.
;; All rights reserved.
;;
;; Redistribution and use in source and binary forms, with or without
;; modification, are permitted provided that the following conditions are met:
;;
;; * Redistributions of source code must retain the above copyright notice,
;;   this list of conditions and the following disclaimer.
;;
;; * Redistributions in binary form must reproduce the above copyright notice,
;;   this list of conditions and the following disclaimer in the documentation
;;   and/or other materials provided with the distribution.
;;
;; THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
;; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
;; IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
;; ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
;; LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
;; CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
;; SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
;; INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
;; CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
;; ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
;; POSSIBILITY OF SUCH DAMAGE.
;;
;;*****************************************************************************

import Microsoft.AspNetCore.JsonPatch
import Microsoft.VisualStudio.TestTools.UnitTesting
import Newtonsoft.Json
import System.Collections.Generic
import System.Net.Http
import SampleServices
import SampleServices.Test.Models

namespace SampleServices.Test.UnitTests

    {TestClass}
    public partial class ItemTests

        ;;------------------------------------------------------------
        ;;Get all Items

        {TestMethod}
        {TestCategory("Item Tests - Read All")}
        public method GetItems, void
        proc
            disposable data client = UnitTestEnvironment.Server.CreateClient()
            disposable data response = client.GetAsync("/odata/Items").Result
            data result = response.Content.ReadAsStringAsync().Result
            response.EnsureSuccessStatusCode()
            data items, @ODataItems, JsonConvert.DeserializeObject<ODataItems>(result)
        endmethod

        ;;------------------------------------------------------------
        ;;Get all Items and expand relation REL_VendorNumber

        {TestMethod}
        {TestCategory("Item Tests - Read All")}
        public method GetItems_Expand_REL_VendorNumber, void
        proc
            data uri = "/odata/Items?$expand=REL_VendorNumber"
            disposable data client = UnitTestEnvironment.Server.CreateClient()
            disposable data response = client.GetAsync(uri).Result
            data result = response.Content.ReadAsStringAsync().Result
            response.EnsureSuccessStatusCode()
        endmethod

        ;;------------------------------------------------------------
        ;;Get all Items and expand relation REL_ItemNumber

        {TestMethod}
        {TestCategory("Item Tests - Read All")}
        public method GetItems_Expand_REL_OrderItems, void
        proc
            data uri = "/odata/Items?$expand=REL_OrderItems"
            disposable data client = UnitTestEnvironment.Server.CreateClient()
            disposable data response = client.GetAsync(uri).Result
            data result = response.Content.ReadAsStringAsync().Result
            response.EnsureSuccessStatusCode()
        endmethod

        ;;------------------------------------------------------------
        ;;Get all Items and expand all relations

        {TestMethod}
        {TestCategory("Item Tests - Read All")}
        public method GetItems_Expand_All, void
        proc
            data uri = "/odata/Items?$expand=REL_VendorNumber,REL_OrderItems"
            disposable data client = UnitTestEnvironment.Server.CreateClient()
            disposable data response = client.GetAsync(uri).Result
            data result = response.Content.ReadAsStringAsync().Result
            response.EnsureSuccessStatusCode()
        endmethod
        
        ;;------------------------------------------------------------
        ;;Get a single Item by primary key

        {TestMethod}
        {TestCategory("Item Tests - Read by Primary Key")}
        public method GetItem, void
        proc
            data client = UnitTestEnvironment.Server.CreateClient()
            data request = String.Format("/odata/Items(ItemNumber={1})","",TestConstants.GetItem_ItemNumber)
            data response = client.GetAsync(request).Result
            data result = response.Content.ReadAsStringAsync().Result
            response.EnsureSuccessStatusCode()
            data item, @ODataItem, JsonConvert.DeserializeObject<ODataItem>(result)
        endmethod

        ;;------------------------------------------------------------
        ;;Get a single Item by primary key and expand relation REL_VendorNumber


        {TestMethod}
        {TestCategory("Item Tests - Read by Primary Key")}
        public method GetItem_Expand_REL_VendorNumber, void
        proc
            data client = UnitTestEnvironment.Server.CreateClient()
            data request = String.Format("/odata/Items(ItemNumber={1})?$expand=REL_VendorNumber","",TestConstants.GetItem_Expand_REL_VendorNumber_ItemNumber)
            data response = client.GetAsync(request).Result
            data result = response.Content.ReadAsStringAsync().Result
            response.EnsureSuccessStatusCode()
            data item, @ODataItem, JsonConvert.DeserializeObject<ODataItem>(result)
        endmethod

        ;;------------------------------------------------------------
        ;;Get a single Item by primary key and expand relation REL_OrderItems


        {TestMethod}
        {TestCategory("Item Tests - Read by Primary Key")}
        public method GetItem_Expand_REL_OrderItems, void
        proc
            data client = UnitTestEnvironment.Server.CreateClient()
            data request = String.Format("/odata/Items(ItemNumber={1})?$expand=REL_OrderItems","",TestConstants.GetItem_Expand_REL_OrderItems_ItemNumber)
            data response = client.GetAsync(request).Result
            data result = response.Content.ReadAsStringAsync().Result
            response.EnsureSuccessStatusCode()
            data item, @ODataItem, JsonConvert.DeserializeObject<ODataItem>(result)
        endmethod

        ;;------------------------------------------------------------
        ;;Get a single Item by primary key and expand all relations

        {TestMethod}
        {TestCategory("Item Tests - Read by Primary Key")}
        public method GetItem_Expand_All, void
        proc
            data client = UnitTestEnvironment.Server.CreateClient()
            data request = String.Format("/odata/Items(ItemNumber={1})?$expand=REL_VendorNumber,REL_OrderItems","",TestConstants.GetItem_Expand_All_ItemNumber)
            data response = client.GetAsync(request).Result
            data result = response.Content.ReadAsStringAsync().Result
            response.EnsureSuccessStatusCode()
            data item, @ODataItem, JsonConvert.DeserializeObject<ODataItem>(result)
        endmethod

        ;;------------------------------------------------------------
        ;;Get a single Item by alternate key 1 (VendorNumber)

        {TestMethod}
        {TestCategory("Item Tests - Read by Alternate Key")}
        public method GetItem_ByAltKey_VendorNumber, void
        proc
            data client = UnitTestEnvironment.Server.CreateClient()
            data request = String.Format("/odata/Items(VendorNumber={1})", "", TestConstants.GetItem_ByAltKey_VendorNumber_VendorNumber)
            data response = client.GetAsync(request).Result
            data result = response.Content.ReadAsStringAsync().Result
            response.EnsureSuccessStatusCode()
            data items, @ODataItems,JsonConvert.DeserializeObject<ODataItems>(result)
        endmethod

        ;;------------------------------------------------------------
        ;;Get a single Item by alternate key 2 (Color)

        {TestMethod}
        {TestCategory("Item Tests - Read by Alternate Key")}
        public method GetItem_ByAltKey_Color, void
        proc
            data client = UnitTestEnvironment.Server.CreateClient()
            data request = String.Format("/odata/Items(FlowerColor='{1}')", "", TestConstants.GetItem_ByAltKey_Color_FlowerColor)
            data response = client.GetAsync(request).Result
            data result = response.Content.ReadAsStringAsync().Result
            response.EnsureSuccessStatusCode()
            data items, @ODataItems,JsonConvert.DeserializeObject<ODataItems>(result)
        endmethod

        ;;------------------------------------------------------------
        ;;Get a single Item by alternate key 3 (Size)

        {TestMethod}
        {TestCategory("Item Tests - Read by Alternate Key")}
        public method GetItem_ByAltKey_Size, void
        proc
            data client = UnitTestEnvironment.Server.CreateClient()
            data request = String.Format("/odata/Items(Size={1})", "", TestConstants.GetItem_ByAltKey_Size_Size)
            data response = client.GetAsync(request).Result
            data result = response.Content.ReadAsStringAsync().Result
            response.EnsureSuccessStatusCode()
            data items, @ODataItems,JsonConvert.DeserializeObject<ODataItems>(result)
        endmethod

        ;;------------------------------------------------------------
        ;;Get a single Item by alternate key 4 (Name)

        {TestMethod}
        {TestCategory("Item Tests - Read by Alternate Key")}
        public method GetItem_ByAltKey_Name, void
        proc
            data client = UnitTestEnvironment.Server.CreateClient()
            data request = String.Format("/odata/Items(CommonName='{1}')", "", TestConstants.GetItem_ByAltKey_Name_CommonName)
            data response = client.GetAsync(request).Result
            data result = response.Content.ReadAsStringAsync().Result
            response.EnsureSuccessStatusCode()
            data items, @ODataItems,JsonConvert.DeserializeObject<ODataItems>(result)
        endmethod

        ;;------------------------------------------------------------
        ;;Create new Item (client specified key)

        {TestMethod}
        {TestCategory("Item Tests - Create, Update & Delete")}
        public method UpdateItem, void
        proc
            disposable data client = UnitTestEnvironment.Server.CreateClient()

            ;;Get one item from the file
            data getRequest = String.Format("/odata/Items(ItemNumber={1})","",TestConstants.GetItem_ItemNumber)
            data getResponse = client.GetAsync(getRequest).Result
            data getResult = getResponse.Content.ReadAsStringAsync().Result

            ;;Check that we got a successful response from the web service
            getResponse.EnsureSuccessStatusCode()

            ;;Deserialize the JSON into a Item object
            data doItem, @Item, JsonConvert.DeserializeObject<Item>(getResult)

            doItem.ItemNumber = TestConstants.UpdateItem_ItemNumber

            ;TODO: Also need to ensure any nodups alternate keys get unique values

            ;;Create new item
            disposable data requestBody = new StringContent(JsonConvert.SerializeObject(doItem),System.Text.Encoding.UTF8, "application/json")
            data request = String.Format("/odata/Items(ItemNumber={1})","",TestConstants.UpdateItem_ItemNumber)
            disposable data response = client.PutAsync(request, requestBody).Result

            ;;Check that we got a successful response from the web service
            response.EnsureSuccessStatusCode()

            ;;Get the inserted record
            getResponse = client.GetAsync(request).Result
            getResult = getResponse.Content.ReadAsStringAsync().Result

            ;;Check that we got a successful response from the web service
            getResponse.EnsureSuccessStatusCode()

            ;;Deserialize the JSON into a Item object
            doItem = JsonConvert.DeserializeObject<Item>(getResult)

            ;;Change the first non key field to test full update
            doItem.LatinName = "Y"

            ;;Update full item
            requestBody = new StringContent(JsonConvert.SerializeObject(doItem),System.Text.Encoding.UTF8, "application/json")
            request = String.Format("/odata/Items(ItemNumber={1})","",TestConstants.UpdateItem_ItemNumber)
            response = client.PutAsync(request, requestBody).Result

            ;;Check that we got a successful response from the web service
            response.EnsureSuccessStatusCode()

            ;;Get the inserted record
            getResponse = client.GetAsync(request).Result
            getResult = getResponse.Content.ReadAsStringAsync().Result

            ;;Check that we got a successful response from the web service
            getResponse.EnsureSuccessStatusCode()

            ;;Deserialize the JSON into a Item object
            doItem = JsonConvert.DeserializeObject<Item>(getResult)

            Assert.AreEqual(doItem.LatinName, "Y")

            ;;Update one property in the item
            data patchDoc = new JsonPatchDocument()
            patchDoc.Replace("LatinName", "Z")

            ;;Serialize the patch to JSON
            data serializedPatch = JsonConvert.SerializeObject(patchDoc)

            ;;Apply the patch
            disposable data patchRequestBody = new StringContent(serializedPatch,System.Text.Encoding.UTF8, "application/json-patch+json")
            disposable data patchResponse = client.PatchAsync(request, patchRequestBody).Result

            ;;Check that we got a successful response from the web service
            patchResponse.EnsureSuccessStatusCode()

            ;;Get the updated item record
            getResponse = client.GetAsync(request).Result
            getResult = getResponse.Content.ReadAsStringAsync().Result

            ;;Check that we got a successful response from the web service
            getResponse.EnsureSuccessStatusCode()

            ;;Deserialize the JSON into a Item object
            doItem = JsonConvert.DeserializeObject<Item>(getResult)

            ;;Verify that the property was changed
            Assert.AreEqual(doItem.LatinName, "Z")

            ;;Delete It
            disposable data deleteResponse = client.DeleteAsync(request).Result

            ;;Check that we got a successful response from the web service
            getResponse.EnsureSuccessStatusCode()

            ;;Attempt to get the deleted record
            getResponse = client.GetAsync(request).Result

            ;;Check we got a fail state from the web service
            Assert.AreEqual(getResponse.IsSuccessStatusCode, false)

        endmethod

    endclass

endnamespace
